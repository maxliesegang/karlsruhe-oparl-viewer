---
import type {
  Paper,
  PaperFilterData,
  PaperFilterOptions,
} from "../shared/types";
import { buildVorlagenDetailUrl, formatDateLong } from "../shared/utils";
import { INITIAL_PAPERS_BATCH_SIZE } from "../shared/papers-table-filters";
import PapersFiltersPanel from "./PapersFiltersPanel.astro";

interface Props {
  papers: Paper[];
  filterData?: Record<string, PaperFilterData>;
  filterOptions?: PaperFilterOptions;
}

const { papers = [], filterData, filterOptions } = Astro.props;
const base = import.meta.env.BASE_URL;
const hasFilters = Boolean(filterOptions && filterData);
const META_EMPTY_VALUES = new Set(["Keine Angabe", "Keine Angaben"]);

/** Extract date part (YYYY-MM-DD) from an ISO datetime string. */
function toDateKey(modified: string): string {
  return modified.slice(0, 10);
}

function getMeaningfulMetaValue(value?: string): string | undefined {
  if (!value) return undefined;
  const normalizedValue = value.trim();
  if (!normalizedValue || META_EMPTY_VALUES.has(normalizedValue)) {
    return undefined;
  }
  return normalizedValue;
}

function buildPaperMetaText(paper: Paper, data?: PaperFilterData): string {
  const lastResult = getMeaningfulMetaValue(data?.lastResult);
  const stadtteileLabel = getMeaningfulMetaValue(data?.stadtteileLabel);

  return [
    paper.reference,
    paper.paperType,
    data?.organizationNames,
    data?.lastRole,
    lastResult,
    stadtteileLabel ? `Erw채hnte Stadtteile: ${stadtteileLabel}` : undefined,
  ]
    .filter(Boolean)
    .join(" \u00B7 ");
}
---

{
  papers.length > 0 ? (
    <div class="papers-panel" data-papers-table>
      {hasFilters && filterOptions && (
        <PapersFiltersPanel filterOptions={filterOptions} />
      )}
      <ul class="paper-list">
        {papers.map((paper, i) => {
          const fd = filterData?.[paper.reference];
          const dateKey = toDateKey(paper.modified);
          const prevDateKey = i > 0 ? toDateKey(papers[i - 1].modified) : null;
          const showHeader = dateKey !== prevDateKey;
          const metaText = buildPaperMetaText(paper, fd);
          const isInitiallyVisible = i < INITIAL_PAPERS_BATCH_SIZE;
          const showHeaderInitially = showHeader && isInitiallyVisible;

          return (
            <>
              {showHeader && (
                <li
                  class="date-group-header"
                  data-date={dateKey}
                  style={showHeaderInitially ? undefined : "display:none;"}
                >
                  Aktualisiert am {formatDateLong(paper.modified)}
                </li>
              )}
              <li
                data-date-group={dateKey}
                style={isInitiallyVisible ? undefined : "display:none;"}
              >
                <a
                  class="paper-card"
                  href={buildVorlagenDetailUrl(base, paper.internalReference)}
                  data-year={fd?.year ?? ""}
                  data-paper-type={paper.paperType}
                  data-organization={fd?.organizationNames ?? ""}
                  data-role={fd?.lastRole ?? ""}
                  data-result={fd?.lastResult ?? ""}
                  data-stadtteile={fd?.stadtteileFilterValue ?? ""}
                >
                  <span class="paper-title">{paper.name}</span>
                  <span class="paper-meta" title={metaText}>
                    {metaText}
                  </span>
                </a>
              </li>
            </>
          );
        })}
      </ul>
      <p class="load-trigger" data-load-trigger hidden>
        Weitere Vorlagen werden geladen...
      </p>
      <p class="no-results" id="no-results" style="display: none;">
        Keine Vorlagen f체r die gew채hlten Filter gefunden.
      </p>
    </div>
  ) : (
    <p class="empty">Keine Vorlagen verf체gbar.</p>
  )
}

<style>
  .papers-panel {
    background: #fff;
    border-radius: var(--radius);
    box-shadow: var(--shadow-card);
    overflow: hidden;
  }

  /* --- Paper list --- */

  .paper-list {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .date-group-header {
    padding: 10px 24px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    color: var(--color-text-muted);
    background: #f8f9fa;
    border-bottom: 1px solid var(--color-border);
    border-top: 1px solid var(--color-border);
  }

  .date-group-header:first-child {
    border-top: none;
  }

  .paper-card {
    display: block;
    padding: 18px 24px;
    text-decoration: none;
    color: inherit;
    border-bottom: 1px solid var(--color-border);
  }

  .paper-card:hover {
    background: #fafafa;
  }

  .paper-title {
    display: block;
    font-size: 1.05rem;
    color: var(--color-text);
    line-height: 1.55;
    margin-bottom: 6px;
  }

  .paper-meta {
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 1;
    line-clamp: 1;
    font-size: 0.85rem;
    color: #888;
    line-height: 1.4;
    overflow: hidden;
    overflow-wrap: anywhere;
  }

  @media screen and (max-width: 1100px) {
    .paper-meta {
      -webkit-line-clamp: 2;
      line-clamp: 2;
    }
  }

  li:last-child .paper-card {
    border-bottom: none;
  }

  .no-results,
  .empty {
    color: var(--color-text-muted);
    font-style: italic;
    padding: 32px 24px;
    margin: 0;
    text-align: center;
  }

  .load-trigger {
    margin: 0;
    padding: 16px 24px;
    text-align: center;
    color: var(--color-text-muted);
    font-size: 0.85rem;
    border-top: 1px solid var(--color-border);
    background: #fafafa;
  }

  /* --- Mobile --- */

  @media screen and (max-width: 768px) {
    .date-group-header {
      padding: 10px 16px;
    }

    .paper-card {
      padding: 14px 16px;
    }

    .paper-meta {
      -webkit-line-clamp: 3;
      line-clamp: 3;
    }
  }
</style>

<script>
  import { initPapersTableFilters } from "../shared/papers-table-filters";

  initPapersTableFilters();
</script>
