---
import type {
  Paper,
  PaperFilterData,
  PaperFilterOptions,
} from "../shared/types";
import { formatDateLong } from "../shared/utils";
import FilterSelect from "./FilterSelect.astro";

interface Props {
  papers: Paper[];
  filterData?: Record<string, PaperFilterData>;
  filterOptions?: PaperFilterOptions;
}

const { papers = [], filterData, filterOptions } = Astro.props;
const base = import.meta.env.BASE_URL;
const hasFilters = filterOptions && filterData;
const META_EMPTY_VALUES = new Set(["Keine Angabe", "Keine Angaben"]);
const FILTER_FIELDS: Array<{
  id: string;
  label: string;
  optionsKey: keyof PaperFilterOptions;
}> = [
  { id: "filter-type", label: "Art", optionsKey: "paperTypes" },
  {
    id: "filter-org",
    label: "Unter Leitung von",
    optionsKey: "organizations",
  },
  { id: "filter-role", label: "Letzte Rolle", optionsKey: "roles" },
  {
    id: "filter-result",
    label: "Letztes Beratungsergebnis",
    optionsKey: "results",
  },
  {
    id: "filter-stadtteil",
    label: "Erwähnter Stadtteil",
    optionsKey: "stadtteile",
  },
];

/** Extract date part (YYYY-MM-DD) from an ISO datetime string. */
function toDateKey(modified: string): string {
  return modified.slice(0, 10);
}

function getMeaningfulMetaValue(value?: string): string | undefined {
  if (!value) return undefined;
  const normalizedValue = value.trim();
  if (!normalizedValue || META_EMPTY_VALUES.has(normalizedValue)) {
    return undefined;
  }
  return normalizedValue;
}

function buildPaperMetaText(paper: Paper, data?: PaperFilterData): string {
  const lastResult = getMeaningfulMetaValue(data?.lastResult);
  const stadtteileLabel = getMeaningfulMetaValue(data?.stadtteileLabel);

  return [
    paper.reference,
    paper.paperType,
    data?.organizationNames,
    data?.lastRole,
    lastResult,
    stadtteileLabel ? `Erwähnte Stadtteile: ${stadtteileLabel}` : undefined,
  ]
    .filter(Boolean)
    .join(" \u00B7 ");
}
---

{
  papers.length > 0 ? (
    <div class="papers-panel" data-papers-table>
      {hasFilters && (
        <div class="filters">
          <div class="filter-row">
            {FILTER_FIELDS.map((field) => (
              <FilterSelect
                id={field.id}
                label={field.label}
                options={filterOptions?.[field.optionsKey] ?? []}
              />
            ))}
          </div>
          <p class="filter-count" id="filter-count" />
        </div>
      )}
      <ul class="paper-list">
        {papers.map((paper, i) => {
          const fd = filterData?.[paper.reference];
          const dateKey = toDateKey(paper.modified);
          const prevDateKey = i > 0 ? toDateKey(papers[i - 1].modified) : null;
          const showHeader = dateKey !== prevDateKey;
          const metaText = buildPaperMetaText(paper, fd);

          return (
            <>
              {showHeader && (
                <li class="date-group-header" data-date={dateKey}>
                  Aktualisiert am {formatDateLong(paper.modified)}
                </li>
              )}
              <li data-date-group={dateKey}>
                <a
                  class="paper-card"
                  href={`${base}vorlage/${paper.internalReference}`}
                  data-paper-type={paper.paperType}
                  data-organization={fd?.organizationNames ?? ""}
                  data-role={fd?.lastRole ?? ""}
                  data-result={fd?.lastResult ?? ""}
                  data-stadtteile={fd?.stadtteileFilterValue ?? ""}
                >
                  <span class="paper-title">{paper.name}</span>
                  <span class="paper-meta" title={metaText}>
                    {metaText}
                  </span>
                </a>
              </li>
            </>
          );
        })}
      </ul>
      <p class="no-results" id="no-results" style="display: none;">
        Keine Vorlagen für die gewählten Filter gefunden.
      </p>
    </div>
  ) : (
    <p class="empty">Keine Vorlagen verfügbar.</p>
  )
}

<style>
  .papers-panel {
    background: #fff;
    border-radius: var(--radius);
    box-shadow: var(--shadow-card);
    overflow: hidden;
  }

  /* --- Filters --- */

  .filters {
    padding: 16px 24px;
    background: #f8f9fa;
    border-bottom: 1px solid var(--color-border);
  }

  .filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
  }

  .filter-count {
    margin: 8px 0 0;
    font-size: 0.82rem;
    color: var(--color-text-muted);
    min-height: 1.2em;
  }

  /* --- Paper list --- */

  .paper-list {
    list-style: none;
    margin: 0;
    padding: 0;
  }

  .date-group-header {
    padding: 10px 24px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    color: var(--color-text-muted);
    background: #f8f9fa;
    border-bottom: 1px solid var(--color-border);
    border-top: 1px solid var(--color-border);
  }

  .date-group-header:first-child {
    border-top: none;
  }

  .paper-card {
    display: block;
    padding: 18px 24px;
    text-decoration: none;
    color: inherit;
    border-bottom: 1px solid var(--color-border);
  }

  .paper-card:hover {
    background: #fafafa;
  }

  .paper-title {
    display: block;
    font-size: 1.05rem;
    color: var(--color-text);
    line-height: 1.55;
    margin-bottom: 6px;
  }

  .paper-meta {
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 1;
    line-clamp: 1;
    font-size: 0.85rem;
    color: #888;
    line-height: 1.4;
    overflow: hidden;
    overflow-wrap: anywhere;
  }

  @media screen and (max-width: 1100px) {
    .paper-meta {
      -webkit-line-clamp: 2;
      line-clamp: 2;
    }
  }

  li:last-child .paper-card {
    border-bottom: none;
  }

  .no-results,
  .empty {
    color: var(--color-text-muted);
    font-style: italic;
    padding: 32px 24px;
    margin: 0;
    text-align: center;
  }

  /* --- Mobile --- */

  @media screen and (max-width: 768px) {
    .filter-row {
      flex-direction: column;
    }

    .date-group-header {
      padding: 10px 16px;
    }

    .paper-card {
      padding: 14px 16px;
    }

    .paper-meta {
      -webkit-line-clamp: 3;
      line-clamp: 3;
    }

    .filters {
      padding: 14px 16px;
    }
  }
</style>

<script>
  import { initPapersTableFilters } from "../shared/papers-table-filters";

  initPapersTableFilters();
</script>
