---
import Layout from "../layouts/Layout.astro";
import PapersTable from "../components/PapersTable.astro";
import YearLinks from "../components/YearLinks.astro";
import {
  loadPapers,
  loadOrganizations,
  loadMeetings,
  getAllAvailableYears,
  getRelevantYear,
} from "../shared/data";
import type {
  Meeting,
  Organization,
  Paper,
  PaperFilterData,
  PaperFilterOptions,
} from "../shared/types";

const NO_VALUE = "Keine Angabe";
const NO_VALUES = "Keine Angaben";

function normalizeValues(values: string[] = []): string[] {
  return [...new Set(values.map((value) => value.trim()).filter(Boolean))];
}

function getOrganizationNames(
  paper: Paper,
  organizations: Map<string, Organization>,
): string {
  const orgNames = (paper.underDirectionOf || [])
    .map((id) => organizations.get(id)?.name)
    .filter((name): name is string => !!name);

  return orgNames.length > 0 ? orgNames.join(", ") : NO_VALUES;
}

function getLastConsultationMeta(
  paper: Paper,
  meetings: Map<string, Meeting>,
): { lastRole: string; lastResult: string } {
  let lastRole = NO_VALUE;
  let lastResult = NO_VALUE;

  for (const consultation of paper.consultation || []) {
    if (consultation.role) {
      lastRole = consultation.role;
    }

    const meeting = meetings.get(consultation.meeting);
    const agendaItem = meeting?.agendaItem?.find(
      (item) => item.id === consultation.agendaItem,
    );
    if (agendaItem?.result) {
      lastResult = agendaItem.result;
    }
  }

  return { lastRole, lastResult };
}

function getStadtteileMeta(paper: Paper): {
  stadtteile: string[];
  stadtteileLabel: string;
  stadtteileFilterValue: string;
} {
  const stadtteile = normalizeValues(paper.stadtteile);
  const stadtteileLabel =
    stadtteile.length > 0 ? stadtteile.join(", ") : NO_VALUES;

  return {
    stadtteile,
    stadtteileLabel,
    stadtteileFilterValue: stadtteile.join("|"),
  };
}

export async function getStaticPaths() {
  const allYears = await getAllAvailableYears();

  return allYears.map((year) => ({
    params: { year },
  }));
}

const { year } = Astro.params;
const [allPapers, allYears, orgsMap, meetingsMap] = await Promise.all([
  loadPapers(),
  getAllAvailableYears(),
  loadOrganizations(),
  loadMeetings(),
]);
const papers = allPapers.filter((p) => getRelevantYear(p) === year);

const filterData: Record<string, PaperFilterData> = {};
const paperTypeSet = new Set<string>();
const organizationSet = new Set<string>();
const roleSet = new Set<string>();
const resultSet = new Set<string>();
const stadtteilSet = new Set<string>();

for (const paper of papers) {
  const organizationNames = getOrganizationNames(paper, orgsMap);
  const { lastRole, lastResult } = getLastConsultationMeta(paper, meetingsMap);
  const { stadtteile, stadtteileLabel, stadtteileFilterValue } =
    getStadtteileMeta(paper);

  filterData[paper.reference] = {
    organizationNames,
    lastRole,
    lastResult,
    stadtteileLabel,
    stadtteileFilterValue,
  };

  if (paper.paperType) paperTypeSet.add(paper.paperType);
  organizationSet.add(organizationNames);
  if (lastRole) roleSet.add(lastRole);
  if (lastResult) resultSet.add(lastResult);
  for (const stadtteil of stadtteile) {
    stadtteilSet.add(stadtteil);
  }
}

const filterOptions: PaperFilterOptions = {
  paperTypes: [...paperTypeSet].sort(),
  organizations: [...organizationSet].sort(),
  roles: [...roleSet].sort(),
  results: [...resultSet].sort(),
  stadtteile: [...stadtteilSet].sort(),
};
---

<Layout>
  <div class="vorlagen-page">
    <h1 class="page-header">Vorlagen {year}</h1>

    <YearLinks allYears={allYears} currentYear={year} />

    <div data-pagefind-ignore>
      <PapersTable
        papers={papers}
        filterData={filterData}
        filterOptions={filterOptions}
      />
    </div>
  </div>
</Layout>

<style>
  .vorlagen-page {
    max-width: 1400px;
    margin: 0 auto;
  }
</style>
