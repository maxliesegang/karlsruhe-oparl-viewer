---
import Layout from "../../layouts/Layout.astro";
import PaperListingPage from "../../components/PaperListingPage.astro";
import StadtteilHint from "../../components/StadtteilHint.astro";
import {
  loadPapers,
  loadOrganizations,
  loadMeetings,
  getAllAvailableStadtteile,
} from "../../shared/data";
import { buildFilterData } from "../../shared/paper-filter-utils";
import { slugify } from "../../shared/utils";

export async function getStaticPaths() {
  const stadtteile = await getAllAvailableStadtteile();
  return stadtteile.map((name) => ({
    params: { name: slugify(name) },
    props: { stadtteilName: name },
  }));
}

const { stadtteilName } = Astro.props;
const base = import.meta.env.BASE_URL;

const [allPapers, orgsMap, meetingsMap] = await Promise.all([
  loadPapers(),
  loadOrganizations(),
  loadMeetings(),
]);

const papers = allPapers.filter((p) =>
  (p.stadtteile || []).some((s) => s.trim() === stadtteilName),
);

const { filterData, filterOptions } = buildFilterData(
  papers,
  orgsMap,
  meetingsMap,
);
---

<Layout title={stadtteilName}>
  <PaperListingPage
    title={stadtteilName}
    papers={papers}
    filterData={filterData}
    filterOptions={filterOptions}
  >
    <p slot="intro" class="subtitle">
      {papers.length} Vorlagen &middot;
      <a href={`${base}stadtteile`} class="back-link">Alle Stadtteile</a>
    </p>
    <StadtteilHint slot="intro" />
  </PaperListingPage>
</Layout>

<style>
  .subtitle {
    text-align: center;
    color: var(--color-text-muted);
    margin-bottom: 14px;
  }

  .back-link {
    color: var(--color-link);
    text-decoration: none;
  }

  .back-link:hover {
    text-decoration: underline;
  }
</style>
